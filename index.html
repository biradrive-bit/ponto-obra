<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Ponto Digital - Obra Central</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f4f7f6; margin: 0; padding: 10px; padding-bottom: 80px; }
        #login-screen { padding: 40px 20px; background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 400px; margin: 50px auto; }
        input, textarea { padding: 12px; width: 85%; font-size: 1.1em; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; text-align: center; box-sizing: border-box; }
        #camera-container { position: relative; width: 100%; max-width: 350px; margin: auto; border-radius: 15px; overflow: hidden; border: 3px solid #2c3e50; display: none; background: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #canvas { width: 100%; display: block; }
        .scanner-target { position: absolute; top: 50%; left: 50%; width: 65%; height: 50%; transform: translate(-50%, -50%); border: 2px solid rgba(40, 167, 69, 0.8); box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.45); border-radius: 10px; pointer-events: none; z-index: 10; }
        .scanner-target::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: #39ff14; box-shadow: 0 0 12px #39ff14; animation: scan 2s infinite linear; }
        @keyframes scan { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }
        .btn-start { padding: 20px; background: #2c3e50; color: white; border: none; border-radius: 10px; font-weight: bold; width: 100%; max-width: 350px; font-size: 1.2em; cursor: pointer; }
        .btn-login { padding: 15px 30px; background: #007bff; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1em; cursor: pointer; width: 100%; }
        #confirm-box { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 1000; width: 85%; max-width: 350px; max-height: 90vh; overflow-y: auto; }
        .btn-status { padding: 12px; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1em; margin: 5px; width: 100%; cursor: pointer; box-sizing: border-box; }
        .p { background: #28a745; } .f { background: #dc3545; } .fer { background: #ffc107; color: black !important; } .a { background: #17a2b8; } .dec { background: #6f42c1; } .c { background: #6c757d; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
        .secao-extra { display: none; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 10px; border: 1px dashed #ccc; }
        #lista-lidos { margin-top: 20px; text-align: left; max-width: 350px; margin-left: auto; margin-right: auto; background: white; border-radius: 10px; padding: 10px; border: 1px solid #ddd; display: none; }
        .item-lido { border-bottom: 1px solid #eee; padding: 8px; font-size: 0.9em; color: #333; font-weight: 600; }
        .rodape-fixo { position: fixed; bottom: 0; left: 0; width: 100%; background: #2c3e50; color: white; padding: 15px 0; font-size: 0.8em; font-weight: bold; z-index: 1001; }
        .status-conexao { position: fixed; top: 10px; right: 10px; display: flex; align-items: center; font-size: 0.7em; z-index: 1002; font-weight: bold; }
        .bolinha { width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .online { background: #28a745; box-shadow: 0 0 8px #28a745; }
        .offline { background: #dc3545; box-shadow: 0 0 8px #dc3545; }
    </style>
</head>
<body>
    <div class="status-conexao">
        <div id="status-bola" class="bolinha online"></div>
        <span id="status-texto">ONLINE</span>
    </div>

    <div id="login-screen">
        <h2>Acesso Restrito</h2>
        <input type="password" id="pass-input" placeholder="Sua Senha">
        <button class="btn-login" id="btn-login-id" onclick="verificarSenha()">ENTRAR</button>
    </div>

    <div id="app-content" style="display:none;">
        <h2 style="margin-bottom: 10px; color: #2c3e50;">üèóÔ∏è Registro de Ponto</h2>
        <div id="camera-container">
            <canvas id="canvas"></canvas>
            <div class="scanner-target"></div>
        </div>
        <button id="start-btn" class="btn-start" style="margin-top:10px;" onclick="iniciarLeitor()">‚ñ∂Ô∏è LIGAR C√ÇMERA</button>
        <div id="lista-lidos">
            <strong>üìã Registrados hoje:</strong>
            <div id="itens-container"></div>
        </div>
        <div class="rodape-fixo">¬© 2026 Denis Carvalho - Gest√£o de Obras</div>
    </div>

    <div id="overlay"></div>
    <div id="confirm-box">
        <div id="confirm-content">
            <span id="nome-exibir" style="font-weight:bold; font-size:1.3em; display:block; margin-bottom:15px; color: #2c3e50;">---</span>
            <div id="botoes-principais">
                <button class="btn-status p" onclick="prepararEnvio('PRESENTE')">‚úÖ PRESENTE</button>
                <button class="btn-status f" onclick="prepararEnvio('FALTA')">‚ùå FALTA</button>
                <button class="btn-status fer" onclick="abrirExtra('FERIAS')">üå¥ F√âRIAS</button>
                <button class="btn-status a" onclick="abrirExtra('ATESTADO')">üìÑ ATESTADO</button>
                <button class="btn-status dec" onclick="abrirExtra('DECLARACAO')">üïí DECLARA√á√ÉO</button>
                <button class="btn-status c" onclick="fechar()">CANCELAR</button>
            </div>
            <div id="area-extra" class="secao-extra">
                <label id="label-dinamico" style="font-size: 0.9em; font-weight: bold; display: block; margin-bottom: 5px; color: #2c3e50;"></label>
                <input type="date" id="data-extra">
                <input type="text" id="obs-extra" placeholder="Dura√ß√£o">
                <div id="container-foto" style="margin-top: 10px; border-top: 1px solid #ddd; padding-top: 10px;">
                   <p style="font-size: 0.8em; color: red;"><strong>Documento Obrigat√≥rio:</strong></p>
                   <button type="button" class="btn-status a" onclick="document.getElementById('input-camera').click()">üì∏ TIRAR FOTO AGORA</button>
                   <input type="file" id="input-camera" accept="image/*" capture="environment" style="display:none" onchange="atualizarTexto(this)">
                   <button type="button" class="btn-status c" onclick="document.getElementById('input-galeria').click()">üñºÔ∏è GALERIA / ARQUIVOS</button>
                   <input type="file" id="input-galeria" accept="image/*" style="display:none" onchange="atualizarTexto(this)">
                   <p id="nome-arquivo" style="font-size: 0.8em; font-weight: bold; color: #28a745; margin-top: 5px;"></p>
                </div>
                <button class="btn-status p" style="margin-top:15px; background: #007bff;" onclick="validarEEnviarExtra()">CONFIRMAR E ENVIAR</button>
                <button class="btn-status c" onclick="voltarParaBotoes()">VOLTAR</button>
            </div>
        </div>
        <div id="loading" style="display:none; color: #007bff;"><h3>‚è≥ Gravando...</h3></div>
    </div>

    <script>
        const URL_API = "https://script.google.com/macros/s/AKfycbz72EnYFJOHmHzTumWJPBhKG7R1gUTBx2nDjdjf06a1lpI5IMLesrCXaN1tVMQu6fio/exec";
        let video = document.createElement("video");
        let canvasElement = document.getElementById("canvas");
        let canvas = canvasElement.getContext("2d", { willReadFrequently: true });
        let qrPendente = "", bloqueioAtivo = false, currentLat = "0", currentLon = "0", senhaAtiva = "", statusSelecionado = "";
        
        let registrosDaSessao = [];
        const hojeStr = new Date().toLocaleDateString();

        function carregarMemoria() {
            const qrsSalvos = localStorage.getItem('lista_qrs_' + hojeStr);
            const htmlSalvo = localStorage.getItem('lista_html_' + hojeStr);
            if (qrsSalvos && htmlSalvo) {
                registrosDaSessao = JSON.parse(qrsSalvos);
                document.getElementById('itens-container').innerHTML = htmlSalvo;
            } else {
                localStorage.clear(); 
            }
        }
        
        function salvarMemoria() {
            localStorage.setItem('lista_qrs_' + hojeStr, JSON.stringify(registrosDaSessao));
            localStorage.setItem('lista_html_' + hojeStr, document.getElementById('itens-container').innerHTML);
        }

        function verificarSenha() {
            const pass = document.getElementById('pass-input').value;
            if(!pass) return alert("Digite a senha");
            document.getElementById('btn-login-id').innerText = "Aguarde...";
            fetch(URL_API, {
                method: 'POST',
                body: JSON.stringify({ acao: "verificarSenha" })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('btn-login-id').innerText = "ENTRAR";
                if (data.sucesso && data.senhas.split(",").includes(pass)) {
                    senhaAtiva = pass;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app-content').style.display = 'block';
                    document.getElementById('lista-lidos').style.display = 'block';
                    carregarMemoria();
                    obterLocalizacao();
                } else { alert("Senha Incorreta!"); }
            })
            .catch(err => {
                document.getElementById('btn-login-id').innerText = "ENTRAR";
                alert("Erro de conex√£o.");
            });
        }

        function obterLocalizacao() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    currentLat = pos.coords.latitude; currentLon = pos.coords.longitude;
                }, null, {enableHighAccuracy: true});
            }
        }

        function tocarBip() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } catch (e) { }
        }

        function atualizarTexto(el) {
            if (el.files[0]) {
                document.getElementById('nome-arquivo').innerText = "‚úîÔ∏è Selecionado: " + el.files[0].name;
            }
        }

        async function iniciarLeitor() {
            try {
                if (video.srcObject) { video.srcObject.getTracks().forEach(track => track.stop()); }
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                if (!window.tickRodando) {
                    window.tickRodando = true;
                    requestAnimationFrame(tick);
                }
                document.getElementById("start-btn").style.display = "none";
                document.getElementById("camera-container").style.display = "block";
            } catch (err) { alert("C√¢mera bloqueada."); }
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA && !bloqueioAtivo) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                var code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                if (code) {
                    let text = code.data;
                    tocarBip();
                    if (registrosDaSessao.includes(text)) {
                        if(!confirm("‚ö†Ô∏è Funcion√°rio j√° registrado hoje. Deseja lan√ßar outro registro (Ex: Atestado ou F√©rias)?")) {
                            requestAnimationFrame(tick);
                            return;
                        }
                    }
                    bloqueioAtivo = true; qrPendente = text;
                    let i = text.indexOf(" ");
                    document.getElementById('nome-exibir').innerText = (i !== -1) ? text.substring(i).trim() : text.trim();
                    document.getElementById('overlay').style.display = 'block';
                    document.getElementById('confirm-box').style.display = 'block';
                }
            }
            requestAnimationFrame(tick);
        }

        function abrirExtra(status) {
            statusSelecionado = status;
            const label = document.getElementById('label-dinamico');
            const containerFoto = document.getElementById('container-foto');
            const obsInput = document.getElementById('obs-extra');
            document.getElementById('input-camera').value = "";
            document.getElementById('input-galeria').value = "";
            document.getElementById('nome-arquivo').innerText = "";
            if (status === 'ATESTADO') {
                label.innerText = "Data do Atestado:";
                obsInput.placeholder = "Quantos dias?";
                containerFoto.style.display = "block";
            } else if (status === 'DECLARACAO') {
                label.innerText = "Data da Declara√ß√£o:";
                obsInput.placeholder = "Hor√°rio";
                containerFoto.style.display = "block";
            } else if (status === 'FERIAS') {
                label.innerText = "In√≠cio das F√©rias:";
                obsInput.placeholder = "Dura√ß√£o";
                containerFoto.style.display = "none";
            }
            document.getElementById('botoes-principais').style.display = 'none';
            document.getElementById('area-extra').style.display = 'block';
            document.getElementById('data-extra').valueAsDate = new Date();
        }

        function voltarParaBotoes() {
            document.getElementById('area-extra').style.display = 'none';
            document.getElementById('botoes-principais').style.display = 'block';
        }

        function validarEEnviarExtra() {
            const arquivo = document.getElementById('input-camera').files[0] || document.getElementById('input-galeria').files[0];
            const dataI = document.getElementById('data-extra').value;
            const obs = document.getElementById('obs-extra').value;
            if ((statusSelecionado === 'ATESTADO' || statusSelecionado === 'DECLARACAO') && !arquivo) {
                alert("‚ö†Ô∏è Foto obrigat√≥ria!");
                return;
            }
            document.getElementById('confirm-content').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            if (arquivo) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvasImg = document.createElement('canvas');
                        let width = img.width; let height = img.height;
                        const max_size = 1000;
                        if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; }
                        } else { if (height > max_size) { width *= max_size / height; height = max_size; } }
                        canvasImg.width = width; canvasImg.height = height;
                        const ctx = canvasImg.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrlOtimizada = canvasImg.toDataURL('image/jpeg', 0.7);
                        enviarDados(statusSelecionado, dataUrlOtimizada, dataI, obs);
                    };
                };
                reader.readAsDataURL(arquivo);
            } else { enviarDados(statusSelecionado, null, dataI, obs); }
        }

        function prepararEnvio(status) {
            document.getElementById('confirm-content').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            enviarDados(status, null, "", "");
        }

        function enviarDados(status, fotoBase64, dataI, obs) {
            fetch(URL_API, {
                method: 'POST',
                body: JSON.stringify({ acao: "registrar", dados: qrPendente, statusEscolhido: status, fotoBase64: fotoBase64, lat: currentLat, lon: currentLon, senhaDigitada: senhaAtiva, dataInicio: dataI, observacao: obs })
            })
            .then(res => res.json())
            .then(data => {
                if(data.sucesso) {
                    if (!registrosDaSessao.includes(qrPendente)) {
                        registrosDaSessao.push(qrPendente);
                    }
                    const div = document.createElement('div');
                    div.className = 'item-lido';
                    div.innerText = "‚úÖ " + data.nome + " (" + data.status + ")";
                    document.getElementById('itens-container').prepend(div);
                    salvarMemoria();
                } else { alert("Erro: " + data.erro); }
                fechar();
            })
            .catch(err => { alert("Erro de conex√£o!"); fechar(); });
        }

        function fechar() { 
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('confirm-box').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('area-extra').style.display = 'none';
            document.getElementById('botoes-principais').style.display = 'block';
            document.getElementById('confirm-content').style.display = 'block';
            qrPendente = "";
            if (document.getElementById("camera-container").style.display === "block") { iniciarLeitor(); }
            setTimeout(() => { bloqueioAtivo = false; }, 1000);
        }
        window.addEventListener('online', () => { document.getElementById('status-bola').className = 'bolinha online'; document.getElementById('status-texto').innerText = 'ONLINE'; });
        window.addEventListener('offline', () => { document.getElementById('status-bola').className = 'bolinha offline'; document.getElementById('status-texto').innerText = 'OFFLINE'; });
    </script>
</body>
</html>

