<script>
    const URL_API = "https://script.google.com/macros/s/AKfycbwwfudzbd75ftK21MH3ryMQDy0B6ijEITjjklSivoiNAW_EnJ5Xm3l2r0P9oKVv7_cdfQ/exec";
    let video = document.createElement("video");
    let canvasElement = document.getElementById("canvas");
    let canvas = canvasElement.getContext("2d", { willReadFrequently: true });
    
    // VARIÃVEIS DE CONTROLE
    let qrPendente = "", bloqueioAtivo = false, currentLat = "0", currentLon = "0", senhaAtiva = "", encarregadoAtivo = "", statusSelecionado = "";
    let bloqueioEnvio = false; // ðŸ”’ NOVA TRAVA PARA EVITAR DUPLICIDADE

    function tocarBip() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.frequency.value = 880; o.start(); o.stop(ctx.currentTime + 0.1);
        } catch (e) { }
    }

    function verificarSenha() {
        const p = document.getElementById('pass-input').value;
        if(!p) return alert("Digite a senha");
        document.getElementById('btn-login-id').innerText = "Aguarde...";
        fetch(URL_API, { method: 'POST', body: JSON.stringify({ acao: "verificarSenha", senhaDigitada: p }) })
        .then(res => res.json()).then(data => {
            document.getElementById('btn-login-id').innerText = "ENTRAR";
            if (data.sucesso && data.senhas.split(",").includes(p)) {
                senhaAtiva = p; encarregadoAtivo = data.encarregado;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('lista-lidos').style.display = 'block';
                document.getElementById('info-encarregado').innerText = "Encarregado: " + encarregadoAtivo;
                buscarRegistrosServidor();
                obterLocalizacao();
            } else { alert("Senha Incorreta!"); }
        });
    }

    function obterLocalizacao() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                currentLat = pos.coords.latitude; currentLon = pos.coords.longitude;
            }, null, {enableHighAccuracy: true});
        }
    }

    function buscarRegistrosServidor() {
        fetch(URL_API + "?encarregado=" + encodeURIComponent(encarregadoAtivo))
        .then(r => r.json()).then(d => {
            const cont = document.getElementById('itens-container');
            cont.innerHTML = "";
            if(d.sucesso && d.registros) {
                d.registros.forEach(reg => {
                    cont.innerHTML += `<div class="item-lido">âœ… ${reg.nome} (${reg.status}) - ${reg.hora}</div>`;
                });
            }
        });
    }

    async function iniciarLeitor() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream; video.play();
        requestAnimationFrame(tick);
        document.getElementById("start-btn").style.display = "none";
        document.getElementById("camera-container").style.display = "block";
    }

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA && !bloqueioAtivo) {
            canvasElement.height = video.videoHeight; canvasElement.width = video.videoWidth;
            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            var code = jsQR(canvas.getImageData(0, 0, canvasElement.width, canvasElement.height).data, canvasElement.width, canvasElement.height);
            if (code) {
                bloqueioAtivo = true; qrPendente = code.data;
                tocarBip();
                let i = qrPendente.indexOf(" ");
                let nomeLido = (i !== -1) ? qrPendente.substring(i).trim() : qrPendente;
                document.getElementById('nome-exibir').innerText = nomeLido;
                if (document.getElementById('itens-container').innerText.includes(nomeLido)) {
                    setTimeout(() => {
                        if (!confirm("âš ï¸ " + nomeLido + " jÃ¡ registrado hoje. LanÃ§ar novo status?")) { fechar(); }
                        else { mostrarConfirmacao(); }
                    }, 100);
                } else { mostrarConfirmacao(); }
            }
        }
        requestAnimationFrame(tick);
    }

    function mostrarConfirmacao() {
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('confirm-box').style.display = 'block';
    }

    function abrirExtra(status) {
        statusSelecionado = status;
        const obsInput = document.getElementById('obs-extra');
        document.getElementById('label-dinamico').innerText = "Data do(a) " + status + ":";
        document.getElementById('data-extra').valueAsDate = new Date();
        if (status === 'ATESTADO') {
            obsInput.placeholder = "Qtd dias (Ex: 3)";
        } else if (status === 'DECLARACAO') {
            obsInput.placeholder = "PerÃ­odo (Ex: 07h Ã s 10h)";
        } else {
            obsInput.placeholder = "ObservaÃ§Ã£o";
        }
        document.getElementById('botoes-principais').style.display = 'none';
        document.getElementById('area-extra').style.display = 'block';
    }

    function prepararEnvio(status) {
        enviarFinal(status, null, "", "");
    }

    function validarEEnviarExtra() {
        const arquivo = document.getElementById('input-camera').files[0] || document.getElementById('input-galeria').files[0];
        if ((statusSelecionado === 'ATESTADO' || statusSelecionado === 'DECLARACAO') && !arquivo) return alert("âš ï¸ Foto obrigatÃ³ria!");
        
        if (arquivo) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvasImg = document.createElement('canvas');
                    const max_size = 1000; let w = img.width, h = img.height;
                    if (w > h) { if (w > max_size) { h *= max_size / w; w = max_size; } }
                    else { if (h > max_size) { h *= max_size / h; h = max_size; } }
                    canvasImg.width = w; canvasImg.height = h;
                    canvasImg.getContext('2d').drawImage(img, 0, 0, w, h);
                    enviarFinal(statusSelecionado, canvasImg.toDataURL('image/jpeg', 0.7), document.getElementById('data-extra').value, document.getElementById('obs-extra').value);
                };
            };
            reader.readAsDataURL(arquivo);
        } else { enviarFinal(statusSelecionado, null, document.getElementById('data-extra').value, document.getElementById('obs-extra').value); }
    }

    // FUNÃ‡ÃƒO DE ENVIO COM TRAVA ANTI-DUPLICIDADE
    function enviarFinal(status, foto, dataI, obs) {
        if (bloqueioEnvio) return; // ðŸ›¡ï¸ Aborta se jÃ¡ houver um envio em curso
        
        bloqueioEnvio = true; // Ativa o bloqueio
        document.getElementById('confirm-content').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        fetch(URL_API, {
            method: 'POST',
            body: JSON.stringify({ 
                acao: "registrar", 
                dados: qrPendente, 
                statusEscolhido: status, 
                fotoBase64: foto, 
                lat: currentLat, 
                lon: currentLon, 
                senhaDigitada: senhaAtiva, 
                dataInicio: dataI, 
                observacao: obs 
            })
        })
        .then(() => { 
            buscarRegistrosServidor(); 
            fechar(); 
        })
        .catch(err => {
            alert("Erro ao gravar. Tente novamente.");
            bloqueioEnvio = false; // Libera a trava em caso de erro para tentar de novo
            document.getElementById('loading').style.display = 'none';
            document.getElementById('confirm-content').style.display = 'block';
        });
    }

    function fechar() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('confirm-box').style.display = 'none';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('area-extra').style.display = 'none';
        document.getElementById('confirm-content').style.display = 'block';
        document.getElementById('botoes-principais').style.display = 'block';
        
        qrPendente = ""; 
        bloqueioEnvio = false; // ðŸ”“ Libera a trava para o prÃ³ximo registro
        setTimeout(() => { bloqueioAtivo = false; }, 1200);
    }

    function atualizarTexto(el) { if (el.files[0]) document.getElementById('nome-arquivo').innerText = "âœ”ï¸ Selecionado: " + el.files[0].name; }
    function voltarParaBotoes() { document.getElementById('area-extra').style.display = 'none'; document.getElementById('botoes-principais').style.display = 'block'; }
    window.addEventListener('online', () => { document.getElementById('status-bola').className = 'bolinha online'; document.getElementById('status-texto').innerText = 'ONLINE'; });
    window.addEventListener('offline', () => { document.getElementById('status-bola').className = 'bolinha offline'; document.getElementById('status-texto').innerText = 'OFFLINE'; });
</script>
